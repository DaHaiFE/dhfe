<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浅谈V8引擎中的垃圾回收机制 · 大海前端团队 · 一群有趣有爱的人儿一起做有意义的事儿</title>
    <meta name="description" content="程序运行需要内存，只要程序要求，操作系统就必须提供内存，JavaScript使用自动内存管理，这被称为”垃圾回收机制”,优点是可以简化开发、节省代码，缺点是无法完整的掌握内存的分配与回收的具体过程">
    <link rel="shortcut icon" href="/favicon.ico">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#3F51B5">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="content-type" content="no-cache, must-revalidate">
  <meta http-equiv="expires" content="Wed, 26 Feb 1997 08:21:57 GMT">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/192.png">
  <meta name="msapplication-TileImage" content="/icons/192.png">
  <meta name="msapplication-TileColor" content="#3F51B5">
    
    <link rel="preload" href="/assets/css/styles.7e3bbdcf.css" as="style"><link rel="preload" href="/assets/js/app.7e3bbdcf.js" as="script"><link rel="preload" href="/assets/css/styles.7e3bbdcf.css" as="style"><link rel="preload" href="/assets/js/1.b7c064a0.js" as="script"><link rel="prefetch" href="/assets/js/10.c57460b4.js"><link rel="prefetch" href="/assets/js/11.ef43cd88.js"><link rel="prefetch" href="/assets/js/12.9ac7e3d6.js"><link rel="prefetch" href="/assets/js/13.9e579e95.js"><link rel="prefetch" href="/assets/js/14.81038537.js"><link rel="prefetch" href="/assets/js/15.20f7fea5.js"><link rel="prefetch" href="/assets/js/16.cccdc5d6.js"><link rel="prefetch" href="/assets/js/17.2f55acf1.js"><link rel="prefetch" href="/assets/js/18.04e66a8c.js"><link rel="prefetch" href="/assets/js/19.a350b227.js"><link rel="prefetch" href="/assets/js/2.30690309.js"><link rel="prefetch" href="/assets/js/20.382325d7.js"><link rel="prefetch" href="/assets/js/21.42d01bdd.js"><link rel="prefetch" href="/assets/js/22.bb8a390e.js"><link rel="prefetch" href="/assets/js/23.63a55c5d.js"><link rel="prefetch" href="/assets/js/3.de4e9704.js"><link rel="prefetch" href="/assets/js/4.eae0a007.js"><link rel="prefetch" href="/assets/js/5.95a53548.js"><link rel="prefetch" href="/assets/js/6.7b8bfb0a.js"><link rel="prefetch" href="/assets/js/7.703c38fc.js"><link rel="prefetch" href="/assets/js/8.966beaed.js"><link rel="prefetch" href="/assets/js/9.b035af40.js">
    <link rel="stylesheet" href="/assets/css/styles.7e3bbdcf.css"><link rel="stylesheet" href="/assets/css/styles.7e3bbdcf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div data-app="true" id="app" class="application theme--light"><div class="application--wrap"><div role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" class="v-progress-linear blog-progress" style="height:3px;display:none;"><div class="v-progress-linear__background accent" style="height:3px;opacity:0.4;width:100%;"></div><div class="v-progress-linear__bar"><!----><div class="v-progress-linear__bar__determinate accent" style="width:0%;"></div></div></div><aside class="v-navigation-drawer v-navigation-drawer--close v-navigation-drawer--fixed v-navigation-drawer--is-mobile theme--light" style="height:100%;margin-top:0px;max-height:calc(100% - 0px);transform:translateX(-240px);width:240px;"><div><div class="aside-brand-wrap" style="display:;"><div class="aside-brand"><a href="/" class="aside-avatar elevation-2 router-link-active"><img src="/face.jpg" alt="avatar"></a><hgroup class="mt-3 variant-hide"><div class="subheading white--text">大海前端团队-DHFE</div><a href="javacript:void(0)" title="有爱有趣" class="aside-mail primary--text text--lighten-5">有爱有趣</a></hgroup></div></div><hr class="v-divider theme--dark"><div role="list" class="v-list nav-list theme--light"><div role="listitem" class="secondary--text"><a href="/blog" class="v-list__tile v-list__tile--link theme--light"><div class="v-list__tile__avatar"><div class="v-avatar" style="height:40px;width:40px;"><i class="fa fa-tag"></i></div></div><div class="v-list__tile__content">Blog</div></a></div><div role="listitem" class="secondary--text"><a href="https://github.com/DahaiFE/dhfe" target="_blank" class="v-list__tile v-list__tile--link theme--light"><div class="v-list__tile__avatar"><div class="v-avatar" style="height:40px;width:40px;"><i class="fab fa-github"></i></div></div><div class="v-list__tile__content">Github</div></a></div><div role="listitem" class="secondary--text"><a href="/about" class="v-list__tile v-list__tile--link theme--light"><div class="v-list__tile__avatar"><div class="v-avatar" style="height:40px;width:40px;"><i class="fa fa-user-secret"></i></div></div><div class="v-list__tile__content">About</div></a></div><div role="listitem" class="secondary--text"><a href="/join" class="v-list__tile v-list__tile--link theme--light"><div class="v-list__tile__avatar"><div class="v-avatar" style="height:40px;width:40px;"><i class="fa fa-users"></i></div></div><div class="v-list__tile__content">Join</div></a></div></div></div><div class="v-navigation-drawer__border"></div></aside><main class="v-content" style="padding-top:0px;padding-right:0px;padding-bottom:0px;padding-left:0px;"><div class="v-content__wrap"><div class="container blog-container grid-list-xl align-center"><div class="layout row wrap"><div class="flex mb-3 xs12"><article class="mb-lay v-card v-sheet theme--light elevation-2 elevation-16 post-card"><div class="v-card__title"><div class="flex xs12"><h2 class="display-1 mb-3">浅谈V8引擎中的垃圾回收机制</h2><div class="post-meta"><time datetime="2018-12-17T00:00:00.000Z" class="secondary--text post-time">2018年12月17日</time></div></div></div><div class="v-card__text pt-0 pb-0"><div class="flex xs12"><div class="content custom"><p>参考朴灵的《深入浅出Node.js》及<a href="http://www.jayconrod.com/posts/55/a-tour-of-v8-garbage-collection" target="_blank" rel="noopener noreferrer">A tour of V8:Garbage Collection</a>，后者还有中文翻译版<a href="http://newhtml.net/v8-garbage-collection/" target="_blank" rel="noopener noreferrer">V8 之旅</a></p><h2 id="_1、javascript中垃圾收集"><a href="#_1、javascript中垃圾收集" aria-hidden="true" class="header-anchor">#</a> 1、Javascript中垃圾收集</h2><blockquote><ul><li>程序运行需要内存，只要程序要求，操作系统就必须提供内存</li><li>JavaScript使用自动内存管理，这被称为”垃圾回收机制”（garbage collector)</li><li>优点是可以简化开发、节省代码</li><li>缺点是无法完整的掌握内存的分配与回收的具体过程</li></ul></blockquote><h3 id="_1-1nodejs中的内存管理"><a href="#_1-1nodejs中的内存管理" aria-hidden="true" class="header-anchor">#</a> 1.1NodeJS中的内存管理</h3><blockquote><ul><li>网页端的内存泄漏，影响单个用户</li><li>对于持续运行的服务进程Node服务器端程序,必须及时释放不再用到的内存。否则，内存占用越 来越高，轻则影响系统性能，重则导致进程崩溃,影响的不再是单个用户</li><li>如果不再用到的内存没有及时释放，就叫做内存泄漏</li></ul></blockquote><p><font style="font-size:12px;color:#777;">注：在浏览器中，V8引擎实例的生命周期不会很长，而且运行在用户的机器上。如果不幸发生内存泄露等问题，仅仅会影响到一个终端用户。且无论这个V8实例占用了多少内存，最终在关闭页面时内存都会被释放，几乎没有太多管理的必要（当然并不代表一些大型Web应用不需要管理内存）。但如果使用Node作为服务器，就需要关注内存问题了，一旦内存发生泄漏，久而久之整个服务将会瘫痪（服务器不会频繁的重启）</font></p><h3 id="_1-2v8内存管理"><a href="#_1-2v8内存管理" aria-hidden="true" class="header-anchor">#</a> 1.2V8内存管理</h3><p><strong>V8内存限制</strong></p><blockquote><ul><li>在64位操作系统可以使用1.4G内存</li><li>在32位操作系统中可以使用0.7G内存</li></ul></blockquote><p><strong>V8内存管理</strong></p><blockquote><ul><li>JS对象都是通过V8进行分配管理内存的</li><li>process.memoryUsage
返回一个对象，包含了 Node 进程的内存占用信息</li></ul></blockquote><pre class="language-text"><code>console.log(process.memoryUsage());
/*{
    rss: 19099648,
    heapTotal: 6066176,
    heapUsed: 3808560,
    external: 8264
}*/
</code></pre><p><img src="/assets/img/2018121601.f202e799.png" alt="avatar"></p><p>rss（resident set size）：所有内存占用，包括指令区和堆栈。<br> heapTotal：”堆”占用的内存，包括用到的和没用到的<br> heapUsed：用到的堆的部分。判断内存泄漏，以 heapUsed 字段为准<br> external： V8 引擎内部的 C++ 对象占用的内存
<br>
大小关系: heapUsed &lt; heapTotal &lt; rss <br></p><p><img src="/assets/img/2018121602.5389d736.png" alt="avatar"></p><p><strong>为何限制内存大小</strong></p><blockquote><ul><li>因为V8的垃圾收集工作原理导致的,内存越大垃圾收集时间越大</li><li>垃圾回收的时候整个程序暂停stop-the-world，这个暂停期间，应用的性能和响应能力都会下降</li></ul></blockquote><p><font style="font-size:12px;color:#777;">V8之所以限制了内存的大小，表面上的原因是V8最初是作为浏览器的JavaScript引擎而设计，不太可能遇到大量内存的场景，而深层次的原因则是由于V8的垃圾回收机制的限制。由于V8需要保证JavaScript应用逻辑与垃圾回收器所看到的不一样，V8在执行垃圾回收时会阻塞JavaScript应用逻辑，直到垃圾回收结束再重新执行JavaScript应用逻辑，这种行为被称为“全停顿”（stop-the-world）。若V8的堆内存为1.5GB，V8做一次小的垃圾回收需要50ms以上，做一次非增量式的垃圾回收甚至要1秒以上。这样浏览器将在1s内失去对用户的响应，造成假死现象。如果有动画效果的话，动画的展现也将显著受到影响</font></p><p><strong>如何打开内存限制</strong></p><blockquote><ul><li>一旦初始化成功，生效后不能再修改</li><li>–max-new-space-size，最大 new space 大小，执行 scavenge 回收，默认 16M，单位 KB</li><li>–max-old-space-size，最大 old space 大小，执行 MarkSweep 回收，默认 1G，单位 M</li></ul></blockquote><pre class="language-text"><code>node --max-old-space-size=2000 app.js 单位是M
node --max-new-space-size=1024 app.js 单位是k
</code></pre><h2 id="_2、v8的垃圾回收机制"><a href="#_2、v8的垃圾回收机制" aria-hidden="true" class="header-anchor">#</a> 2、V8的垃圾回收机制</h2><blockquote><ul><li>V8是基于分代的垃圾回收</li><li>不同代垃圾回收机制也不一样</li><li>按存活的时间分为新生代和老生代</li></ul></blockquote><p><strong>分代</strong></p><blockquote><ul><li>年龄小的是新生代,由From区域和To区域两个区域组成<br>
在64位系统里，新生代内存是32M,From区域和To区域各占用16M<br>
在32位系统里，新生代内存是16M,From区域和To区域各占用8M<br></li><li>年龄大的是老生代,默认情况下<br>
64为系统下老生代内存是1400M<br>
32为系统下老生代内存是700M</li></ul></blockquote><p><img src="/assets/img/2018121603.52acd18a.png" alt="avatar"></p><h3 id="_2-2引用计数"><a href="#_2-2引用计数" aria-hidden="true" class="header-anchor">#</a> 2.2引用计数</h3><blockquote><ul><li>语言引擎有一张引用表，保存了内存里面所有的资源的引用次数。</li><li>如果一个值的引用次数是0，就表示这个值不再用到了，因此可以将这块内存释放。</li></ul></blockquote><p><img src="/assets/img/2018121604.862e1c7a.png" alt="avatar"></p><pre class="language-text"><code>function Person(name){
    this.name = name;
}
let p1 = new Person('zfpx1');
let p2 = new Person('zfpx2');
let arr = [p1];
setTimeout(function(){
    p1 = null;
    p2 = null;
},3000);
setTimeout(function(){
    arr = null;
},10000);
let arr = [];
setInterval(function(){
    let obj ={};
    for(let i=0;i&lt;=10000000;i++){
        obj[i] = i;
    }
    arr.push(obj);
},500);
function Person(name){
    this.name = name;
}
let set = new Set();
let weakset = new WeakSet();
let p1 = new Person('zfpx1');
let p2 = new Person('zfpx2');
set.add(p1);
weakset.add(p2);
p1=null;
p2=null;
</code></pre><h3 id="_2-3新生代垃圾回收"><a href="#_2-3新生代垃圾回收" aria-hidden="true" class="header-anchor">#</a> 2.3新生代垃圾回收</h3><blockquote><ul><li>新生代区域一分为二，每个16M，一个使用，一个空闲</li><li>开始垃圾回收的时候，会检查FROM区域中的存活对象，如果还活着，拷贝到TO空间，完成后释 放空间</li><li>完成后 FROM 和 TO 互换</li><li>新生代扫描的时候是一种广度优先的扫描策略</li><li>新生代的空间小，存活对象少</li><li>当一个对象经历过多次的垃圾回收依然存活的时候，生存周期比较长的对象会被移动到老生代， 这个移动过程被成为晋升或者升级<br>
经过5次以上的回收还存在 <br>
TO的空间使用占比超过25%，或者超大对象</li></ul></blockquote><p><img src="/assets/img/2018121605.1ef658c8.png" alt="avatar"><img src="/assets/img/2018121606.ae603e26.png" alt="avatar"></p><h3 id="_2-4老生代"><a href="#_2-4老生代" aria-hidden="true" class="header-anchor">#</a> 2.4老生代</h3><blockquote><ul><li>mark-sweep(标记清除) mark-compact(标记整理)</li><li>老生代空间大，大部分都是活着的对象,GC耗时比较长</li><li>在GC期间无法响应，STOP-THE-WORLD</li><li>V8有一个优化方案，增量处理，把一个大暂停换成多个小暂停 INCREMENT-GC</li></ul></blockquote><p><img src="/assets/img/2018121607.94951b67.png" alt="avatar"></p><p><strong>mark-sweep(标记清除)</strong></p><blockquote><ul><li>标记活着的对象，随后清除在标记阶段没有标记的对象，只清理死亡对象</li><li>问题在于清除后会出现内存不连续的情况，这种内存碎片会对后续的内存分配产生影响</li><li>如果要分配一个大对象，碎片空间无法分配</li></ul></blockquote><p><strong>mark-compact(标记整理)</strong></p><blockquote><ul><li>标记死亡后会对对象进行整理，活着的对象向左移动，移动完成后直接清理掉边界外的内存</li></ul></blockquote><p><strong>incremental marking 增量标记</strong></p><blockquote><ul><li>以上三种回收时都需要暂停程序执行，收集完成后才能恢复， STOP-THE-WORLD 在新生代影响 不大，但是老生代影响就非常大了</li><li>增量标记就是把标记改为了增量标记，把一口气的停顿拆分成了多个小步骤，做完一步程序运行 一会儿，垃圾回收和应用程序运行交替进行，停顿时间可以减少到1/6左右  包括垃圾回收的占用时间</li></ul></blockquote><p><img src="/assets/img/2018121608.b6337d66.png" alt="avatar"></p></div></div></div><div class="v-card__actions"><div class="flex xs12"><a href="/blog/JavaScript"><span tabindex="0" class="v-chip capitalize chip-tag v-chip--label v-chip--small theme--light"><span class="v-chip__content">JavaScript
            </span></span></a><a href="/blog/NodeJs"><span tabindex="0" class="v-chip capitalize chip-tag v-chip--label v-chip--small theme--light"><span class="v-chip__content">NodeJs
            </span></span></a></div></div></article></div><div class="flex text-xs-left xs6"><a href="/posts/wxs.html" class="post-nav v-btn v-btn--flat v-btn--router theme--light"><div class="v-btn__content"><div class="grey--text"><i class="fa mr-1 fa-chevron-left"></i>Prev
                </div><div class="title mt-1 primary--text hidden-xs-only title-font">WXS脚本语言</div></div></a></div><div class="flex text-xs-right xs6"><a href="/posts/text-test.html" class="post-nav v-btn v-btn--flat v-btn--router theme--light"><div class="v-btn__content"><div class="grey--text">Next
                    <i class="fa ml-1 fa-chevron-right"></i></div><div class="title mt-1 primary--text hidden-xs-only title-font">程序猿生存指南</div></div></a></div></div></div></div></main><button type="button" class="v-btn v-btn--bottom v-btn--floating v-btn--fixed v-btn--right theme--light accent" style="display:none;background:#3a8ee6 !important;"><div class="v-btn__content"><i class="fa fa-lg fa-chevron-up"></i></div></button></div></div></div>
    <script src="/assets/js/app.7e3bbdcf.js" defer></script><script src="/assets/js/1.b7c064a0.js" defer></script>
  </body>
</html>
